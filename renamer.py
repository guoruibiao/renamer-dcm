# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'renamerui.ui'
#
# Created by: PyQt5 UI code generator 5.15.1
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.

import os
import sys
from PyQt5.QtGui import QIcon
from PyQt5.QtCore import QEvent
from PyQt5 import QtCore, QtGui, QtWidgets
from PyQt5.QtWidgets import QApplication, QMainWindow, QFileDialog

class Ui_MainWindow(object):
    def setupUi(self, MainWindow):
        MainWindow.setObjectName("MainWindow")
        MainWindow.resize(444, 187)
        MainWindow.setFixedSize(444, 187)
        MainWindow.setAutoFillBackground(True)
        self.centralwidget = QtWidgets.QWidget(MainWindow)
        self.centralwidget.setObjectName("centralwidget")
        self.pushButton = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton.setGeometry(QtCore.QRect(30, 110, 113, 32))
        self.pushButton.setObjectName("pushButton")
        self.pushButton_2 = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton_2.setGeometry(QtCore.QRect(270, 110, 113, 32))
        self.pushButton_2.setObjectName("pushButton_2")
        self.lineEdit = QtWidgets.QLineEdit(self.centralwidget)
        self.lineEdit.setGeometry(QtCore.QRect(40, 70, 291, 21))
        self.lineEdit.setPlaceholderText("")
        self.lineEdit.setObjectName("lineEdit")
        self.label = QtWidgets.QLabel(self.centralwidget)
        self.label.setGeometry(QtCore.QRect(20, 40, 360, 16))
        self.label.setObjectName("label")
        self.pushButton_3 = QtWidgets.QPushButton(self.centralwidget)
        self.pushButton_3.setGeometry(QtCore.QRect(330, 66, 90, 23))
        self.pushButton_3.setObjectName("pushButton_3")
        self.label_2 = QtWidgets.QLabel(self.centralwidget)
        self.label_2.setGeometry(QtCore.QRect(128, 10, 160, 32))
        font = QtGui.QFont()
        font.setFamily("Courier")
        self.label_2.setFont(font)
        self.label_2.setObjectName("label_2")
        MainWindow.setCentralWidget(self.centralwidget)
        self.menubar = QtWidgets.QMenuBar(MainWindow)
        self.menubar.setGeometry(QtCore.QRect(0, 0, 444, 22))
        self.menubar.setObjectName("menubar")
        MainWindow.setMenuBar(self.menubar)
        self.statusbar = QtWidgets.QStatusBar(MainWindow)
        self.statusbar.setObjectName("statusbar")
        MainWindow.setStatusBar(self.statusbar)

        self.retranslateUi(MainWindow)
        QtCore.QMetaObject.connectSlotsByName(MainWindow)

    def retranslateUi(self, MainWindow):
        _translate = QtCore.QCoreApplication.translate
        MainWindow.setWindowTitle(_translate("MainWindow", "ğŸ’ DCM åç¼€å¤„ç†"))
        self.pushButton.setText(_translate("MainWindow", "æ’¤é”€ä¿®æ”¹"))
        self.pushButton_2.setText(_translate("MainWindow", "ç¡®è®¤ä¿®æ”¹"))
        self.label.setText(_translate("MainWindow", "ç›®æ ‡è·¯å¾„"))
        self.pushButton_3.setText(_translate("MainWindow", "é€‰æ‹©æ–‡ä»¶å¤¹"))
        self.label_2.setText(_translate("MainWindow", "å˜å˜è¹¦è¹¦çš„ <font color='green'><strong><blob>dcm</blob></strong></font> æ”¹åç¥å™¨"))
        # è®©è¾“å…¥æ¡†è·å–ç„¦ç‚¹
        self.lineEdit.setFocus()





class Main(QMainWindow, Ui_MainWindow):
    def __init__(self, *args, **kwargs):
        super(Main, self).__init__(*args, **kwargs)
        self.setupUi(self)
        # ä¸­é—´æ•°æ®å­˜å‚¨
        self.filenames = []
        self.changed_filenames = []
        # ç›®æ ‡åç¼€å
        self.suffix = ".dcm"
        # ç»‘å®šäº‹ä»¶
        self._bind_actions()
        self.exclude_extensions = [
            "py"
        ]
        self.exclude_filenames = [
            ".DS_Store",
            "VERSION",
        ]

    def _bind_actions(self):
        # é€‰å–æ–‡ä»¶è·¯å¾„
        self.pushButton_3.clicked.connect(self._get_directory_path)
        # ç»‘å®šä¿®æ”¹äº‹ä»¶
        self.pushButton_2.clicked.connect(self._change_extension)
        # ç»‘å®šæ’¤é”€äº‹ä»¶
        self.pushButton.clicked.connect(self._revoke_extension)
        # lineEdit æ”¹å˜äº‹ä»¶
        self.lineEdit.textChanged.connect(self._line_changed)


    def _get_directory_path(self):
        self.filenames = []
        ftuple = QFileDialog.getOpenFileName(self, "Open File", "./", "Txt (*)")
        if ftuple[0] == "" or "/" not in ftuple[0]:
            self.statusbar.showMessage("æ–‡ä»¶è·¯å¾„é€‰æ‹©å¤±è´¥ï¼Œè¯·é‡æ–°é€‰æ‹©")
            return
        dirname = "/".join(str(ftuple[0]).split("/")[:-1])
        self.lineEdit.setText(dirname)
        # è¯»å–è·¯å¾„ä¸­æ‰€æœ‰æ–‡ä»¶
        self._read_all_filenames(dirname)
        print(self.filenames)

    def _line_changed(self, text):
        folder = str(text)
        if os.path.isfile(folder):
            self.label.setText("è·¯å¾„:{}æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œè¯·ä½¿ç”¨æ–‡ä»¶å¤¹!".format(folder))
            return
        if not os.path.isdir(folder):
            self.label.setText("è·¯å¾„:{}ä¸æ˜¯æ–‡ä»¶å¤¹ï¼Œè¯·ä½¿ç”¨æ–‡ä»¶å¤¹ï¼".format(folder))
            return
        if not os.path.exists(folder):
            self.label.setText("è·¯å¾„:{}ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æ­£ç¡®ï¼".format(folder))
            return
        if str(folder) == "/":
            self.label.setText("è·¯å¾„:{}æ–‡ä»¶å¤ªå¤šï¼Œä¸å»ºè®®æ‰«æï¼".format(folder))
            return
        self.label.setText("å½“å‰è·¯å¾„æ£€æŸ¥é€šè¿‡ï¼Œè¯·ç¡®è®¤æ˜¯å¦è¦ä¿®æ”¹é‡Œé¢çš„æ–‡ä»¶ä¸º dcm æ–‡ä»¶ï¼")
        # æ£€æŸ¥é€šè¿‡å³å¯æ‰«æå¯å¤„ç†æ–‡ä»¶
        print("å½“å‰ folder=", folder)
        self._read_all_filenames(folder)
        # å°†æ‰«æåˆ°çš„æ–‡ä»¶å†…å®¹æ˜¾ç¤ºåˆ°çŠ¶æ€æ 
        self.statusbar.showMessage("å½“å‰ç›®å½•æ‰«æåˆ°{}ä¸ªæ–‡ä»¶ï¼".format(len(self.filenames)))


    def _read_all_filenames(self, path):
        self.filenames = []
        # åˆ¤æ–­è·¯å¾„æœ‰æ•ˆæ€§
        if not os.path.isdir(path):
            self.statusbar.showMessage("å½“å‰è·¯å¾„ï¼š{} ä¸åˆæ³•ï¼Œè¯·é‡æ–°é€‰æ‹©".format(path))
            return
        for root, dir, files in os.walk(path):
            for file in files:
                print(file)
                filename = str(os.path.join(root, file))
                if os.path.isfile(filename) == False:
                    continue
                if file in self.exclude_filenames:
                    continue
                # åˆ¤æ–­æ˜¯å¦æœ‰æ‹“å±•åï¼Œå¯¹æœ‰æ‹“å±•åçš„è¿›è¡Œç‰¹æ®Šè¿‡æ»¤
                if "." in str(file):
                    row = str(file).split(".")
                    if len(row) >= 1 and row[-1] in self.exclude_extensions:
                        continue
                # åŠ å…¥å¾…æ›´æ¢åˆ—è¡¨
                self.filenames.append(filename)
        # å°†æ‰«æåˆ°çš„æ–‡ä»¶å†…å®¹æ˜¾ç¤ºåˆ°çŠ¶æ€æ 
        self.statusbar.showMessage("å½“å‰ç›®å½•æ‰«æåˆ°{}ä¸ªæ–‡ä»¶ï¼".format(len(self.filenames)))

    def _change_extension(self):
        self.changed_filenames = []
        for filename in self.filenames:
            newname = filename + self.suffix
            try:
                os.rename(filename, newname)
            except:
                continue
            self.changed_filenames.append(newname)
        succ = len(self.changed_filenames)
        if succ == 0:
            msg = "æš‚æ—¶æ²¡æœ‰æ–‡ä»¶è¦ä¿®æ”¹"
        else:
            msg = "æˆåŠŸä¿®æ”¹äº†{}ä¸ªæ–‡ä»¶ï¼".format(succ)
        self.statusbar.showMessage(msg)

    def _revoke_extension(self):
        succ = 0
        for filename in self.changed_filenames:
            filename = str(filename)
            if not filename.endswith(self.suffix):
                continue
            newname = os.path.splitext(filename)[0]
            try:
                os.rename(filename, newname)
            except:
                continue
            succ += 1
        # å°†æ”¹åŠ¨å±•ç¤ºåˆ°çŠ¶æ€æ 
        if succ == 0:
            msg = "æš‚æ—¶æ²¡æœ‰æ–‡ä»¶è¦æ’¤é”€"
        else:
            msg = "æˆåŠŸæ’¤é”€äº†{}ä¸ªæ–‡ä»¶ï¼".format(succ)
        self.statusbar.showMessage(msg)



if __name__ == "__main__":
    app = QApplication(sys.argv)
    iconPath = os.path.join(os.path.dirname(sys.modules[__name__].__file__), 'raw.jpg')
    app.setWindowIcon(QIcon(iconPath))
    win = Main()
    win.show()
    sys.exit(app.exec_())